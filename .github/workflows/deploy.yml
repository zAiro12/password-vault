name: ğŸš€ Deploy Password Vault

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  setup-backend:
    name: ğŸ”§ Setup Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          npm install
      
      - name: ğŸ” Create .env file
        run: |
          cd backend
          cat << 'EOF' > .env
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          ADMIN_DEFAULT_USERNAME=${{ secrets.ADMIN_DEFAULT_USERNAME }}
          ADMIN_DEFAULT_PASSWORD=${{ secrets.ADMIN_DEFAULT_PASSWORD }}
          ADMIN_DEFAULT_EMAIL=${{ secrets.ADMIN_DEFAULT_EMAIL }}
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          PORT=3000
          NODE_ENV=production
          EOF
      
      - name: ğŸ—„ï¸ Run database migrations
        run: |
          cd backend
          npm run migrate
        continue-on-error: true
      
      - name: âœ… Backend ready
        run: |
          echo "âœ… Backend configured successfully!"
          echo "ğŸ—„ï¸ Database: ${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}"

  setup-frontend:
    name: ğŸ¨ Setup Frontend
    runs-on: ubuntu-latest
    needs: setup-backend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸ“¦ Install frontend dependencies
        run: |
          cd frontend
          npm install
      
      - name: ğŸ”¨ Build frontend
        run: |
          cd frontend
          npm run build
          # Ensure .nojekyll exists to disable Jekyll processing
          touch dist/.nojekyll
          # Verify 404.html exists for SPA fallback
          test -f dist/404.html || cp dist/index.html dist/404.html
        env:
          NODE_ENV: production
          VITE_API_URL: https://zairo.duckdns.org:3000
      
      - name: ğŸ“¤ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/dist
      
      - name: âœ… Frontend deployed
        run: |
          echo "âœ… Frontend deployed to GitHub Pages!"
          echo "ğŸŒ URL: https://zairo12.github.io/password-vault/"
