name: ğŸš€ Deploy Password Vault

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permette di lanciarlo manualmente

jobs:
  deploy-backend:
    name: ğŸ”§ Deploy Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: ğŸ“¦ Install backend dependencies
        run: |
          cd backend
          npm ci
      
      - name: ğŸ” Create .env file
        run: |
          cd backend
          cat << 'EOF' > .env
          # Database Configuration
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          
          # Admin User
          ADMIN_DEFAULT_USERNAME=${{ secrets.ADMIN_DEFAULT_USERNAME }}
          ADMIN_DEFAULT_PASSWORD=${{ secrets.ADMIN_DEFAULT_PASSWORD }}
          ADMIN_DEFAULT_EMAIL=${{ secrets.ADMIN_DEFAULT_EMAIL }}
          
          # Security Keys
          ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          
          # Server Configuration
          PORT=3000
          NODE_ENV=production
          EOF
      
      - name: ğŸ—„ï¸ Run database migrations
        run: |
          cd backend
          npm run migrate
      
      - name: âœ… Verify backend setup
        run: |
          cd backend
          echo "âœ… Backend dependencies installed"
          echo "âœ… Environment configured"
          echo "âœ… Database migrations executed"
          echo "ğŸš€ Backend ready for deployment!"
      
      - name: ğŸ“Š Show deployment info
        run: |
          echo "================================================"
          echo "ğŸ‰ DEPLOYMENT SUCCESSFUL!"
          echo "================================================"
          echo "ğŸ“¦ Backend: Ready"
          echo "ğŸ—„ï¸  Database: ${{ secrets.DB_HOST }}:${{ secrets.DB_PORT }}"
          echo "ğŸ‘¤ Admin User: ${{ secrets.ADMIN_DEFAULT_USERNAME }}"
          echo "================================================"
          echo ""
          echo "âš ï¸  NEXT STEPS:"
          echo "1. Deploy backend to your server (VPS/Cloud)"
          echo "2. Start backend: cd backend && npm start"
          echo "3. Backend will run on port 3000"
          echo "================================================"

  deploy-frontend:
    name: ğŸ¨ Deploy Frontend (GitHub Pages)
    runs-on: ubuntu-latest
    needs: deploy-backend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: ğŸ“¦ Install frontend dependencies
        run: |
          cd frontend
          npm ci
      
      - name: ğŸ”¨ Build frontend
        run: |
          cd frontend
          npm run build
        env:
          # Configura qui l'URL del tuo backend
          VITE_API_URL: https://zairo.duckdns.org:3000
      
      - name: ğŸ“¤ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/dist
          cname: zairo.duckdns.org  # Opzionale: se usi custom domain
